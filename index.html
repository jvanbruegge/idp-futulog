<!DOCTYPE html><html><head><title>Project report: futuLog</title><style>svg text{font-size:.8rem}*{font-family:sans-serif}main{width:920px}h1{text-align:center}p{text-align:justify}iframe,img{border:1px solid gray;display:block;margin:1em auto;width:90%}#pairs_bars_date{width:100%}.bar{fill:#4682b4}</style><link rel="stylesheet" href="index.39b43136.css"></head><body> <main> <h1 id="project report: futulog">Project report: futuLog</h1> <h2 id="table of contents">Table of contents</h2>  <ul> <li><a href="#introduction">Introduction</a></li> <li><a href="#the-team">The team</a></li> <li><a href="#minimum-viable-product">Minimum Viable Product</a> <ul> <li><a href="#user-interface">User interface</a></li> <li><a href="#administration">Administration</a></li> <li><a href="#backend">Backend</a></li> </ul></li> <li><a href="#further-development">Further development</a> <ul> <li><a href="#administration-interface">Administration interface</a></li> <li><a href="#okta-migration">Okta migration</a></li> <li><a href="#removing-the-need-for-developers">Removing the need for developers</a></li> <li><a href="#open-sourcing-futulog">Open Sourcing futuLog</a></li> </ul></li> <li><a href="#impact">Impact</a></li> </ul>  <h2 id="introduction">Introduction</h2> <p>Due to the COVID-19 pandemic, in the first half of 2020, Futurice had all employees work from home. As the restrictions were partly lifted and some people needed material or equipment from the office, a system had to be put in place to trace contracts. The german government required that in case of a positive COVID-19 test, all other employees that were in contact with the positive individual need to be contacted in order to be tested themselves.</p> <p>At first, this was accomplished with an Excel spreadsheet that everyone could write to. However, this approach quickly showed severe limitations. It was hard hard to use, especially on mobile devices, e.g. it was very easy to accidentaly delete other cells or be off by one column and sign in as another employee. As a result of that, only about 50% of the people that went to the office actually signed into the sheet. Additionally there were some privacy concerns. With the spreadsheet, all historical data was collected for everyone to see, so if anyone was aware that there had been a positive case at a certain date, they could just look up the date and guess who was the person in question.</p> <p>These concrete problems formed the requirements for the development of an application to do the tracing:</p> <ul> <li>Easy to use, with first class mobile support</li> <li>Only a small group (administrators) can see past data for privacy</li> <li>Can export a list of all people that were in contact with a given person in the last two weeks (again only for administrators)</li> </ul> <p>The application that was developed in turn was later called <strong>futuLog</strong>.</p> <h2 id="the team">The team</h2> <p>The team varied over time as client projects required designers and developers as staff. The biggest contributors to futuLog were:</p> <ul> <li>Beatrice Rachello (Design)</li> <li>Simon Messmer (Design)</li> <li>Alex Seidler (Frontend Development)</li> <li>Egor Sorokin (Frontend Development)</li> <li>Pierre Hedkvist (Frontend Development)</li> <li>Viktorija Valsoe (Frontend Development)</li> <li>Jan van Br√ºgge (Me -- Backend Development, later some Frontend Development)</li> </ul> <p>The office management and human care teams of Germany and later on also Finland were acting as the stakeholders, giving feedback and requirements for the project.</p> <h2 id="minimum viable product">Minimum Viable Product</h2> <h3 id="user interface">User interface</h3> <p>Most of the work was in the user interface. The design team started with user research and interviews in order to make futuLog as intuitive as possible. At the same time, the frontend team started setting up the development environment, decided to use <a href="https://reactjs.org/">React</a> with <a href="https://mui.com/">material-ui</a> as a component library for the project. As soon as the first few main pages had a complete design, the team implemented them in the codebase.</p> <p>When a new user first opens futuLog, they are redirected to the welcome screen where they can select their usual office. This will be the office they sign in by default:</p> <p><img src="welcome.3a164e97.png" alt="Screenshot of the welcome page of futuLog"></p> <p>After clicking &quot;start&quot;, or when visiting futuLog the next time, the user starts at the main view:</p> <p><img src="main.910a68a6.png" alt="Screenshot of the main page of futuLog"></p> <p>In this main view the user can immediately book a spot in their default office by clicking the big &quot;Office&quot; button. Once they do, they have the option to confirm their stay. This is meant to be done once you really are in the office and it will lock in that choice:</p> <p><img src="confirm.46576e02.png" alt="Screenshot of the confirm page"></p> <p>With either the &quot;Planning&quot; button in the top bar or the &quot;Planning&quot; button at the bottom, the user gets to the planning view which shows their choices for the next few days:</p> <p><img src="planning.5714bae2.png" alt="Screenshot of the planning page"></p> <p>By clicking on one of the dates, the user can book a spot in advance. This booking view shows the user how many spots are still left in the office and who booked those spots. It also allows them to change the office they want to reserve a spot in:</p> <p><img src="planning_detail.ed227245.png" alt="Screenshot of the detailed planning view"></p> <h3 id="administration">Administration</h3> <p>To make the development faster, the initial version that was deployed internally did not have an administration interface. However, the backend provided an API that could be used by a developer in case a positive case occured before this feature is ready.</p> <p><img src="admin_swagger.5731f10e.png" alt="Screenshot of the API Swagger documentation"></p> <h3 id="backend">Backend</h3> <p>The backend of futuLog is written in <a href="https://www.haskell.org/">Haskell</a>. Haskell is a pure functional programming language with an excellent type system and very good support for concurrency. The public API uses the <a href="https://github.com/haskell-servant/servant">servant</a> library which allows to specify the whole API as a type and get the routing, parsing and error handling for free. For example this snippet defines a complete echo API, that expects a JSON object with a message as POST request body to the <code>/echo</code> URL and returns that message as plain text back:</p> <pre><code class="language-haskell"><span class="keyword">import</span> Aeson
<span class="keyword">import</span> Data.Proxy
<span class="keyword">import</span> Servant.API
<span class="keyword">import</span> Network.Wai.Handler.Warp

<span class="class"><span class="keyword">data</span> <span class="type">Message</span> = <span class="type">MkMessage</span> { <span class="title">msg</span> :: <span class="type">String</span> }</span>
  <span class="keyword">deriving</span> (<span class="type">Generic</span>, <span class="type">FromJSON</span>)

<span class="class"><span class="keyword">type</span> <span class="type">EchoAPI</span> = &quot;echo&quot; :&gt; <span class="type">ReqBody</span> &#x27;[<span class="type">JSON</span>] <span class="type">Message</span> :&gt; <span class="type">Post</span> &#x27;[<span class="type">PlainText</span>] <span class="type">String</span></span>

<span class="title">handler</span> :: <span class="type">Server</span> <span class="type">EchoAPI</span>
<span class="title">handler</span> messageObj = pure (msg messageObj)

<span class="title">main</span> = run <span class="number">8000</span> (serve (<span class="type">Proxy</span> @<span class="type">EchoAPI</span>) handler)
</code></pre> <p>In case the user would send <code>{ &quot;mssg&quot;: &quot;Hello World&quot; }</code> (note the typo in the key), servant would automatically return an appropriate error. Servant was chosen because of this. It allows the developer to focus on the application logic and not on the communication with the outside world.</p> <p>To save all the registrations and to make the query for contacts easy, PostgreSQL was chosen as a database. It is a very mature, open source, easy to use, relational database that enable the developer to do complex queries with SQL. To use PostgreSQL from Haskell, the <a href="https://hackage.haskell.org/package/postgresql-simple">postgresql-simple</a> library was chosen.</p> <p>For the MVP, luckily we did not have to take care about authenticating users. The Futurice IT team provides the company with a platform called Playswarm, that allows easy deployment as a <a href="https://www.docker.com/">Docker</a> container, can provide a PostgreSQL database that already has backups configured and most importantly provides a reverse proxy that takes care of authenticating users with the login.futurice.com service. The whole application architecture for the MVP looks like this:</p> <p><img src="architecture_playswarm.cad7a1b9.png" alt="Architecture diagram of the MVP"></p> <h2 id="further development">Further development</h2> <p>After the deployment of the MVP in June 2020, futuLog was improved. Most of the improvements that are visible to the outside were to enable us to Open Source the application. The goal was to make futuLog independent of Futurice-internal infrastructure and that none of the day to day usage should require hand-holding by a developer.</p> <h3 id="administration interface">Administration interface</h3> <p>Shortly after the initial release, we provided a user interface to see the list of people that were either in the office on a given day or the list of people that were in contact with a given person in a given timeframe. These two views are only accessible to administrators, which at that point had to be added to a config file. This meant that adding new administrators required a developer, but after that, most of the day to day work could be done without one. The first view looks like this:</p> <p><img src="tracking_office.bee31bf2.png" alt="Screenshot of the office tracking page"></p> <p>The second view looks like this:</p> <p><img src="tracking_people.37780578.png" alt="Screenshot of the people tracking page"></p> <p>The data from both of these views can be exported to CSV, which in turn can be imported directly into Excel. So in case of a positive COVID-19 case, the administration team can download the data and easily contact all the people from the list.</p> <h3 id="okta migration">Okta migration</h3> <p>While the backend and the database are already available for anyone to self-host, the big issue was the authentication which was tied to the login.futurice.com infrastructure. In addition to our effords to Open Source futuLog, Futurice itself was moving from that login infrastructure to a new identity provider - Okta. While a migration of playswarm to use the new Okta service was planned, it did not have a concrete timeframe at the time. Okta, like many other identity providers, can authenticate users with multiple open protocols, one of with is <strong>OpenID Connect</strong> (OIDC). By implementing this in the backend, a user of the Open Source version could simply connect their own internal identity provider for futuLog. After learning how OIDC words and implementing it in the backend, the architecture now does not need the proxy any more and can be deployed anywhere where a docker container can run:</p> <p><img src="oidc.1342983d.png" alt="Flow diagram of the OIDC login flow"></p> <p>After implementing this feature, I presented my learnings internally in the company, the recording of which is available on YouTube now:</p> <iframe height="465" src="https://www.youtube-nocookie.com/embed/wk9v5upj_7I" title="YouTube video player" frameborder="0" allowfullscreen></iframe> <h3 id="removing the need for developers">Removing the need for developers</h3> <p>After adding the initial administration interface there were only two tasks that the administration team was not able to do by themselves. The first one was changing the maximum number of people that were allowed in the office at any given day, the second one was adding and removing other administratiors. Before Open Sourcing futuLog we wanted to fix these two issues. The result was two new tabs in the administration section where offices and administrators can be defined.</p> <p>Office tab in read mode: <img src="admin_office_read.61fce591.png" alt="Screenshot of the admin office page in read mode"></p> <p>Office tab in edit mode: <img src="admin_office_edit.f2da5289.png" alt="Screenshot of the admin office page in edit mode"></p> <p>The page to add and remove administrators works in just the same way as the office tab.</p> <h3 id="open sourcing futulog">Open Sourcing futuLog</h3> <p>At that point, futuLog was completely decoupled from the internal infrastructure, did not need any developers or operators beyond initial setup and it was easy to use and mature after over a year of continued usage inside Futurice. At this point we published <a href="https://github.com/futurice/futuLog">the project on GitHub</a> under the permissive MIT license, and announced it with <a href="https://futurice.com/blog/open-sourcing-futulog">a blog post</a>.</p> <h2 id="impact">Impact</h2> <p>To properly assess the impact of futuLog, the collected raw data was processed and analysed. For this, this very report is a static HTML page that fetches that processed and anonymous data and uses client side JavaScript to visualize the data and make it interactive. In total, there were <strong>588</strong> unique people that logged into one of the 5 offices at least once. Those people together have booked a slot in the office <strong>13284</strong> times on <strong>377</strong> different days.</p> <p>The first analysis is how often individual pairs of people have met in the office. In the following visualization, the x-Axis shows how often a unique pair of two people have met in the office, the y-Axis shows how many such pairings exist. &quot;Met&quot; in this context means that they were at the same day in the same office. Looking at the graph we can see that <strong><span id="pairs_bars_max_y"></span> pairs</strong> of two people have met <strong>only once</strong> in the office, while <strong><span id="pairs_bars_max_x_y_pairs"></span></strong> <span id="pairs_bars_have_plural">have</span> met <strong><span id="pairs_bars_max_x"></span></strong> times.</p>  <div> <svg id="pairs_bars" width="900" height="700"/> <div class="line"> <label for="pairs_bars_date">Date: <span id="pairs_bars_value"></span></label> <button id="pairs_bars_play">Play</button> <div class="office"> <input id="pairs_bars_Munich" type="checkbox" checked> <label for="pairs_bars_Munich">Munich</label> </div> <div class="office"> <input id="pairs_bars_Berlin" type="checkbox" checked> <label for="pairs_bars_Berlin">Berlin</label> </div> <div class="office"> <input id="pairs_bars_Stuttgart" type="checkbox" checked> <label for="pairs_bars_Stuttgart">Stuttgart</label> </div> <div class="office"> <input id="pairs_bars_Helsinki" type="checkbox" checked> <label for="pairs_bars_Helsinki">Helsinki</label> </div> <div class="office"> <input id="pairs_bars_Tampere" type="checkbox" checked> <label for="pairs_bars_Tampere">Tampere</label> </div> </div> <input id="pairs_bars_date" type="range"> </div> <p>With the control above it is also possible to see the data per office and over time. Use the slider to see the accumulated date up until the given date or use the &quot;Play&quot; button to see the data as an animation.</p> <p>TODO: Explain the second visualization</p> <div> <svg id="force_graph" width="900" height="700"/> <span id="force_graph_text">Simulation running</span> </div> </main> <script type="module" src="index.9929f911.js"></script>  </body></html>